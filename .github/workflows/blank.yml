name: Push Data to Firebase Storage

on:
  workflow_run:
    workflows: ["Fetch Realtime Channels"]
    types:
      - completed
  workflow_dispatch:
    # Allow manual trigger

jobs:
  push-to-firebase:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase Admin SDK
        run: npm install firebase-admin

      - name: Push data to Firebase
        env:
          FIREBASE_PROJECT_ID: ${{ vars.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ vars.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ vars.FIREBASE_PRIVATE_KEY }}
          FIREBASE_DATABASE_URL: ${{ vars.FIREBASE_DATABASE_URL }}
        run: |
          node << 'EOF'
          const admin = require('firebase-admin');
          const fs = require('fs');
          const path = require('path');

          // Initialize Firebase Admin SDK
          admin.initializeApp({
            credential: admin.credential.cert({
              projectId: process.env.FIREBASE_PROJECT_ID,
              clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
              privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
            }),
            databaseURL: process.env.FIREBASE_DATABASE_URL,
          });

          const db = admin.firestore();

          async function processChannelsData() {
            const channelsDir = 'data/channels';
            
            if (!fs.existsSync(channelsDir)) {
              console.log('No channels directory found');
              process.exit(0);
            }

            // Get the most recent JSON file
            const files = fs.readdirSync(channelsDir)
              .filter(f => f.endsWith('.json'))
              .sort()
              .reverse();

            if (files.length === 0) {
              console.log('No JSON files found');
              process.exit(0);
            }

            const latestFile = path.join(channelsDir, files[0]);
            console.log(`Processing file: ${latestFile}`);

            const rawData = fs.readFileSync(latestFile, 'utf8');
            const data = JSON.parse(rawData);

            // Handle both array and object with data property
            const channels = Array.isArray(data) ? data : (data.data || data.channels || []);

            if (!Array.isArray(channels)) {
              console.log('No valid channels array found in data');
              process.exit(0);
            }

            console.log(`Found ${channels.length} channels to process`);

            const batch = db.batch();
            let insertCount = 0;
            let updateCount = 0;

            for (const channel of channels) {
              // Use channel ID as document ID for insert/update logic
              const channelId = channel.id || channel._id || channel.channelId;
              
              if (!channelId) {
                console.warn('Channel without ID found, skipping:', channel);
                continue;
              }

              const docRef = db.collection('channels').doc(String(channelId));
              const docSnapshot = await docRef.get();

              const channelData = {
                ...channel,
                lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
                fetchedAt: new Date().toISOString(),
              };

              if (docSnapshot.exists) {
                // Update existing document
                batch.update(docRef, channelData);
                updateCount++;
                console.log(`Updating channel: ${channelId}`);
              } else {
                // Insert new document
                channelData.createdAt = admin.firestore.FieldValue.serverTimestamp();
                batch.set(docRef, channelData);
                insertCount++;
                console.log(`Inserting channel: ${channelId}`);
              }
            }

            // Commit the batch
            await batch.commit();
            
            console.log(`\nSummary:`);
            console.log(`- Inserted: ${insertCount} channels`);
            console.log(`- Updated: ${updateCount} channels`);
            console.log(`- Total processed: ${insertCount + updateCount} channels`);
          }

          processChannelsData()
            .then(() => {
              console.log('Data push completed successfully');
              process.exit(0);
            })
            .catch((error) => {
              console.error('Error pushing data to Firebase:', error);
              process.exit(1);
            });
          EOF
